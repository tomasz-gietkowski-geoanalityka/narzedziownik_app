name: Build QGIS Plugin ZIP

on:
  push:
    tags:
      - "v*.*.*"   # np. v1.0.0

env:
  PLUGIN_NAME: narzedziownik_app   # NAZWA katalogu top-level w ZIPie (PEP8/identifier!)

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (opcjonalnie) pobierz wersję z taga, np. v1.2.3
      - name: Derive version from tag
        id: ver
        run: |
          TAG="${GITHUB_REF##*/}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Prepare staging tree
        run: |
          mkdir -p dist/${{ env.PLUGIN_NAME }}
          # skopiuj do stagingu WYŁĄCZNIE to, co ma być w wtyczce:
          rsync -av --exclude '.git' --exclude '.github' --exclude 'dist' \
                    --exclude 'tests' --exclude '*.psd' --exclude '*.ai' \
                    --exclude '.gitignore' --exclude '.gitattributes' \
                    ./ dist/${{ env.PLUGIN_NAME }}/

          # (opcjonalnie) podmień wersję w metadata.txt na wersję z taga
          # sed -i działa na linux; upewnij się, że plik to "metadata.txt"
          if [ -f "dist/${{ env.PLUGIN_NAME }}/metadata.txt" ]; then
            sed -i -E "s/^version=.*$/version=${{ steps.ver.outputs.version }}/" dist/${{ env.PLUGIN_NAME }}/metadata.txt
          fi

          # szybki sanity check plików wymaganych przez QGIS:
          test -f dist/${{ env.PLUGIN_NAME }}/metadata.txt
          test -f dist/${{ env.PLUGIN_NAME }}/__init__.py

      - name: Create ZIP with correct top-level dir
        run: |
          cd dist
          zip -r "${{ env.PLUGIN_NAME }}.zip" "${{ env.PLUGIN_NAME }}"

      - name: Upload artifact (for debugging / manual download)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}.zip
          path: dist/${{ env.PLUGIN_NAME }}.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}.zip
          path: dist

      - name: Create GitHub Release & upload asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ env.PLUGIN_NAME }}.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
