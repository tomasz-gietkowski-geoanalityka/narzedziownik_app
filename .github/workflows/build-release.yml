name: Build QGIS Plugin ZIP

on:
  push:
    tags:
      - "v*.*.*"   # np. v1.0.0
  workflow_dispatch:

env:
  # NAZWA katalogu top-level w ZIP (musi być poprawnym identyfikatorem Pythona)
  PLUGIN_NAME: narzedziownik_app
  # >>> TU PODAJ KATALOG ZE ŹRÓDŁAMI WTYCZKI (względem root repo)
  # przykłady: ".", "plugin", "qgis/narzedziownik_app", "src/plugin"
  PLUGIN_SRC_DIR: tomasz-gietkowski-geoanalityka/narzedziownik_app

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repo tree (debug)
        run: |
          echo "Repo root listing:"
          ls -la
          echo "Selected PLUGIN_SRC_DIR: ${{ env.PLUGIN_SRC_DIR }}"
          echo "Listing of PLUGIN_SRC_DIR:"
          ls -la "${{ env.PLUGIN_SRC_DIR }}"

      - name: Prepare staging
        run: |
          set -euo pipefail
          mkdir -p "dist/${{ env.PLUGIN_NAME }}"

          # Kopiujemy ZAWARTOŚĆ katalogu źródeł do stagingu (uwaga na trailing slash!)
          rsync -av \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'dist' \
            --exclude 'tests' \
            --exclude '__pycache__' \
            --exclude '*.psd' \
            --exclude '*.ai' \
            --exclude '*.zip' \
            --exclude '.gitignore' \
            --exclude '.gitattributes' \
            "${{ env.PLUGIN_SRC_DIR }}/" "dist/${{ env.PLUGIN_NAME }}/"

          echo "Staging listing:"
          ls -la "dist/${{ env.PLUGIN_NAME }}"

          # sanity check – te pliki MUSZĄ istnieć w stagingu
          test -f "dist/${{ env.PLUGIN_NAME }}/metadata.txt"
          test -f "dist/${{ env.PLUGIN_NAME }}/__init__.py"

      - name: Create ZIP
        run: |
          cd dist
          zip -r "${{ env.PLUGIN_NAME }}.zip" "${{ env.PLUGIN_NAME }}"
          echo "ZIP contents:"
          unzip -l "${{ env.PLUGIN_NAME }}.zip" | sed -n '1,200p'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}.zip
          path: dist/${{ env.PLUGIN_NAME }}.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download ZIP
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}.zip
          path: dist

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ env.PLUGIN_NAME }}.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
